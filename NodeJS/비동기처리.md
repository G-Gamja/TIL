참조: https://puleugo.tistory.com/133#google_vignette

콜 스택(Call Stack): 자바스크립트 코드가 실행되는 스택입니다. 함수 호출이 스택에 쌓이고, 실행이 완료되면 스택에서 제거됩니다.
태스크 큐(Task Queue): 비동기 작업(예: setTimeout, fetch 요청 등)이 완료되면 콜백 함수가 태스크 큐에 추가됩니다.
이벤트 루프(Event Loop): 이벤트 루프는 콜 스택이 비어 있을 때 태스크 큐에서 콜백 함수를 가져와 실행합니다.

이벤트 루프(Event Loop)
이벤트 루프는 Node.js의 핵심 메커니즘으로, 비동기 작업을 관리하고 콜백 함수가 실행될 준비가 되었을 때 이를 콜 스택(Call Stack)에 추가하는 역할을 합니다. 이벤트 루프는 계속해서 콜 스택이 비어 있는지 확인하고, 비어 있으면 대기 중인 콜백을 실행합니다.

태스크 큐(Task Queue)
태스크 큐는 비동기 작업이 완료된 후 실행될 콜백 함수들이 대기하는 큐입니다. 비동기 작업이 완료되면 해당 작업의 콜백 함수가 태스크 큐에 추가됩니다. 태스크 큐는 여러 종류가 있으며, 대표적으로 다음과 같은 큐가 있습니다:

콜 스택에 비동기 처리가 들어오면 백그라운드 스래드로 넘겨버림
백그라운드 스래드에서 처리가 다 되면 이벤트 루프로 콜백함수를 넘겨버림
이벤트 루프는 콜 스택이 비어있을 때 태스크 큐에서 콜백함수를 가져와 실행함

    ```javascript
    // 콜 스택
    console.log("Hello");

    // 백그라운드 스래드
    setTimeout(() => {
      console.log("World");
    }, 1000);

    // 이벤트 루프
    console.log("Hello World");
    ```

콜 스택에 `console.log("Hello")`가 들어가고, 백그라운드 스래드로 `setTimeout`이 넘어갑니다. 그리고 이벤트 루프로 `console.log("Hello World")`가 넘어갑니다. 1초 후에 백그라운드 스래드에서 `console.log("World")`가 콜 스택으로 넘어갑니다.

이벤트 루프는 콜 스택이 비어있을 때 태스크 큐에서 콜백함수를 가져와 실행함

Node.js의 비동기 처리 로직을 콜 스택, 백그라운드 스레드, 이벤트 루프, 태스크 큐를 포함하여 설명하겠습니다. 아래 코드를 예시로 사용하겠습니다.

1. 비동기 작업 요청: 비동기 작업이 요청되면, 해당 작업은 백그라운드 스레드로 전달됩니다. 2.백그라운드 스레드에서 작업 처리: 백그라운드 스레드는 작업을 처리하고, 완료되면 콜백 함수를 태스크 큐에 추가합니다.
2. 이벤트 루프에서 콜백 실행: 이벤트 루프는 콜 스택이 비어 있을 때 태스크 큐에서 콜백 함수를 가져와 콜 스택에 추가합니다.
3. 콜백 함수 실행: 콜 스택에 추가된 콜백 함수가 실행됩니다.

```javascript
// 비동기 작업을 요청하는 함수
function asyncTask(callback) {
  console.log("비동기 작업 시작");

  // 2초 후에 콜백 함수를 실행하는 타이머 설정
  setTimeout(() => {
    console.log("비동기 작업 완료");
    callback();
  }, 2000);
}

// 메인 함수
function main() {
  console.log("메인 함수 시작");

  // 비동기 작업 요청
  asyncTask(() => {
    console.log("콜백 함수 실행");
  });

  console.log("메인 함수 종료");
}

// 프로그램 시작
main();
```

### 실행 순서와 각 단계의 동작

1. **프로그램 시작**: `main` 함수가 호출됩니다.

   - **콜 스택**: `main` 함수가 콜 스택에 추가됩니다.
   - **콘솔 출력**: "메인 함수 시작"이 출력됩니다.

2. **비동기 작업 요청**: `asyncTask` 함수가 호출됩니다.

   - **콜 스택**: `asyncTask` 함수가 콜 스택에 추가됩니다.
   - **콘솔 출력**: "비동기 작업 시작"이 출력됩니다.

3. **타이머 설정**: `setTimeout` 함수가 호출됩니다.

   - **콜 스택**: `setTimeout` 함수가 콜 스택에 추가됩니다.
   - **백그라운드 스레드**: 타이머가 백그라운드 스레드에서 2초 동안 실행됩니다.
   - **콜 스택**: `setTimeout` 함수가 콜 스택에서 제거됩니다.
   - **콜 스택**: `asyncTask` 함수가 콜 스택에서 제거됩니다.

4. **메인 함수 종료**: `main` 함수의 마지막 줄이 실행됩니다.

   - **콘솔 출력**: "메인 함수 종료"가 출력됩니다.
   - **콜 스택**: `main` 함수가 콜 스택에서 제거됩니다.

5. **타이머 만료**: 2초 후 타이머가 만료됩니다.

   - **백그라운드 스레드**: 타이머가 만료되면 콜백 함수가 태스크 큐(Task Queue)에 추가됩니다.

6. **이벤트 루프**: 이벤트 루프가 콜 스택이 비어 있는지 확인합니다.

   - **콜 스택**: 콜 스택이 비어 있으므로, 태스크 큐에서 콜백 함수를 가져와 콜 스택에 추가합니다.

7. **콜백 함수 실행**: 콜백 함수가 실행됩니다.
   - **콜 스택**: 콜백 함수가 콜 스택에 추가됩니다.
   - **콘솔 출력**: "비동기 작업 완료"가 출력됩니다.
   - **콘솔 출력**: "콜백 함수 실행"이 출력됩니다.
   - **콜 스택**: 콜백 함수가 콜 스택에서 제거됩니다.

### 아스키 아트로 설명

#### 1. 프로그램 시작

```
+---------------------+
|  Call Stack         |
|---------------------|
| main                |
+---------------------+
        |
        v
+---------------------+
|  Console            |
|---------------------|
| "메인 함수 시작"    |
+---------------------+
```

#### 2. 비동기 작업 요청

```
+---------------------+
|  Call Stack         |
|---------------------|
| asyncTask           |
| main                |
+---------------------+
        |
        v
+---------------------+
|  Console            |
|---------------------|
| "비동기 작업 시작"  |
+---------------------+
```

#### 3. 타이머 설정

```
+---------------------+
|  Call Stack         |
|---------------------|
| main                |
+---------------------+
        |
        v
+---------------------+
|  Background Threads |
|---------------------|
| setTimeout (2초)    |
+---------------------+
```

#### 4. 메인 함수 종료

```
+---------------------+
|  Call Stack         |
|---------------------|
| main                |
+---------------------+
        |
        v
+---------------------+
|  Console            |
|---------------------|
| "메인 함수 종료"    |
+---------------------+
```

#### 5. 타이머 만료

```
+---------------------+
|  Task Queue         |
|---------------------|
| callback            |
+---------------------+
        |
        v
+---------------------+
|  Background Threads |
|---------------------|
| (idle)              |
+---------------------+
```

#### 6. 이벤트 루프

```
+---------------------+
|  Call Stack         |
|---------------------|
| callback            |
+---------------------+
        |
        v
+---------------------+
|  Event Loop         |
|---------------------|
| (process tasks)     |
+---------------------+
```

#### 7. 콜백 함수 실행

```
+---------------------+
|  Call Stack         |
|---------------------|
| callback            |
+---------------------+
        |
        v
+---------------------+
|  Console            |
|---------------------|
| "비동기 작업 완료"  |
| "콜백 함수 실행"    |
+---------------------+
```

이 과정을 통해 Node.js는 단일 스레드에서 비동기 작업을 효율적으로 처리할 수 있습니다. 이벤트 루프는 콜 스택이 비어 있을 때 태스크 큐에서 콜백 함수를 가져와 콜 스택에 추가하고, 콜 스택에 추가된 콜백 함수는 실행됩니다.

---

Node.js에서 이벤트 루프와 태스크 큐(Task Queue)는 비동기 작업을 처리하는 데 중요한 역할을 합니다. 이 두 가지는 서로 협력하여 비동기 작업을 효율적으로 처리합니다. 다음은 이벤트 루프와 태스크 큐의 관계에 대한 설명입니다.

### 이벤트 루프(Event Loop)

이벤트 루프는 Node.js의 핵심 메커니즘으로, 비동기 작업을 관리하고 콜백 함수가 실행될 준비가 되었을 때 이를 콜 스택(Call Stack)에 추가하는 역할을 합니다. 이벤트 루프는 계속해서 콜 스택이 비어 있는지 확인하고, 비어 있으면 대기 중인 콜백을 실행합니다.

### 태스크 큐(Task Queue)

태스크 큐는 비동기 작업이 완료된 후 실행될 콜백 함수들이 대기하는 큐입니다. 비동기 작업이 완료되면 해당 작업의 콜백 함수가 태스크 큐에 추가됩니다. 태스크 큐는 여러 종류가 있으며, 대표적으로 다음과 같은 큐가 있습니다:

- **타이머 큐**: `setTimeout`과 `setInterval`의 콜백이 대기하는 큐입니다.
- **I/O 큐**: 파일 시스템, 네트워크 등의 I/O 작업이 완료된 후 실행될 콜백이 대기하는 큐입니다.
- **체크 큐**: `setImmediate`의 콜백이 대기하는 큐입니다.
- **클로즈 큐**: `close` 이벤트가 발생한 콜백이 대기하는 큐입니다.

### 동작 원리

1. **비동기 작업 요청**: 비동기 작업이 요청되면, 해당 작업은 백그라운드 스레드로 전달됩니다.
2. **백그라운드 스레드에서 작업 처리**: 백그라운드 스레드는 작업을 처리하고, 완료되면 콜백 함수를 태스크 큐에 추가합니다.
3. **이벤트 루프에서 콜백 실행**: 이벤트 루프는 콜 스택이 비어 있을 때 태스크 큐에서 콜백 함수를 가져와 콜 스택에 추가합니다.
4. **콜백 함수 실행**: 콜 스택에 추가된 콜백 함수가 실행됩니다.

### 예시: `setTimeout`을 사용한 비동기 작업

```javascript
console.log("프로그램 시작");

setTimeout(() => {
  console.log("타이머 완료");
}, 1000);

console.log("프로그램 종료");
```

### 콘솔 출력 결과

```
프로그램 시작
프로그램 종료
타이머 완료
```
