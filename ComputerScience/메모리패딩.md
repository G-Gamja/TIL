# 메모리 패딩 (Memory Padding)

## 한 줄 요약

CPU가 메모리를 효율적으로 읽기 위해, 구조체 필드 사이에 빈 공간(패딩)을 넣어 정렬하는 것.

## 왜 필요한가?

CPU는 메모리를 읽을 때 **한 바이트씩 읽지 않는다.** 32비트 CPU는 4바이트, 64비트 CPU는 8바이트 단위로 한 번에 읽는다.

만약 4바이트 int 변수가 메모리 주소 `0x01`처럼 정렬되지 않은 위치에 있으면:

- CPU가 두 번에 걸쳐 읽고 조합해야 한다 (성능 저하)
- 일부 아키텍처(ARM 등)에서는 아예 **에러**가 난다

그래서 컴파일러가 알아서 각 필드를 **자기 크기의 배수 주소**에 배치한다. 이때 생기는 빈 공간이 **패딩**이다.

## 핵심 규칙

1. **각 필드는 자신의 크기의 배수 주소에 정렬된다**
   - `char`(1바이트): 아무 주소 OK
   - `short`(2바이트): 2의 배수 주소
   - `int`(4바이트): 4의 배수 주소
   - `double`(8바이트): 8의 배수 주소

2. **구조체 전체 크기는 가장 큰 필드의 배수로 맞춘다** (끝에도 패딩이 붙을 수 있음)

## 예시로 이해하기

### 패딩이 많이 생기는 경우

```c
struct Bad {
    char  a;   // 1바이트  → 오프셋 0
                // 3바이트 패딩 (b를 4의 배수에 놓기 위해)
    int   b;   // 4바이트  → 오프셋 4
    char  c;   // 1바이트  → 오프셋 8
                // 3바이트 패딩 (구조체 크기를 4의 배수로 맞추기 위해)
};
// sizeof = 12바이트 (실제 데이터는 6바이트, 패딩 6바이트)
```

메모리 레이아웃:

```text
[a][패][패][패][b][b][b][b][c][패][패][패]
 0  1  2  3   4  5  6  7  8  9  10  11
```

### 필드 순서만 바꾸면 줄어든다

```c
struct Good {
    int   b;   // 4바이트  → 오프셋 0
    char  a;   // 1바이트  → 오프셋 4
    char  c;   // 1바이트  → 오프셋 5
                // 2바이트 패딩 (구조체 크기를 4의 배수로 맞추기 위해)
};
// sizeof = 8바이트 (실제 데이터 6바이트, 패딩 2바이트)
```

메모리 레이아웃:

```text
[b][b][b][b][a][c][패][패]
 0  1  2  3  4  5  6   7
```

**같은 필드인데 순서만 바꿔서 12바이트 → 8바이트로 줄었다.**

## 실전 팁

### 필드 정렬 요령

**큰 타입부터 작은 타입 순서로 선언하면 패딩이 최소화된다.**

```c
struct Optimal {
    double d;  // 8바이트
    int    i;  // 4바이트
    short  s;  // 2바이트
    char   c;  // 1바이트
    // 1바이트 패딩
};
// sizeof = 16바이트 (최소)
```

### 패딩 강제 제거

패딩을 없애고 싶을 때 (네트워크 프로토콜, 파일 포맷 등):

```c
// GCC/Clang
struct __attribute__((packed)) NoPadding {
    char  a;
    int   b;
    char  c;
};
// sizeof = 6바이트 (패딩 없음)

// MSVC
#pragma pack(push, 1)
struct NoPadding {
    char  a;
    int   b;
    char  c;
};
#pragma pack(pop)
```

> **주의**: packed를 쓰면 비정렬 접근이 발생해 성능이 떨어지고, 일부 아키텍처에서는 크래시할 수 있다. 꼭 필요한 경우에만 사용한다.

## 정리

| 개념 | 내용 |
| ------ | ------ |
| **왜** | CPU가 정렬된 주소에서 데이터를 더 빠르게 읽으니까 |
| **누가** | 컴파일러가 자동으로 패딩을 삽입 |
| **규칙** | 각 필드는 자기 크기의 배수 주소에 정렬 |
| **최적화** | 큰 타입 → 작은 타입 순서로 선언 |
| **제거** | `packed` 속성 사용 (성능 트레이드오프 있음) |
