## swap route

- post

```json
{
  "amountIn": "1000000",
  "sourceAsset": {
    "denom": "uusdc",
    "chainId": "axelar-dojo-1"
  },
  "destAsset": {
    "denom": "uatom",
    "chainId": "cosmoshub-4"
  },
  "cumulativeAffiliateFeeBps": "0"
}
```

- response

\*\* hops는 체인간 중간다리 체인을 의미함

악셀러 (1 USDC) -> 코스모스(ATOM)

```json
{
  "preSwapHops": [
    {
      "port": "transfer",
      // 여기가 출발 체인
      "channel": "channel-78", // 악셀러 쪽 채널
      "chainId": "axelar-dojo-1",

      "pfmEnabled": false,

      // 도착 체인에서 들어온 코인에 해당되는 데놈
      "destDenom": "ibc/F082B65C88E4B6D5EF1DB243CDA1D331D002759E938A0F5CD3FFDC5D53B3E349" // 뉴트론 체인
    }
  ],
  "postSwapHops": [
    {
      "port": "transfer",

      // 출발 체인(뉴트론)
      "channel": "channel-1",
      "chainId": "neutron-1",
      "pfmEnabled": true,
      // 도착한 코스모스 체인에서 받을 코인 데놈
      "destDenom": "uatom"
    }
  ],
  // 사용될 체인들의 체인아이디
  "chainIds": ["axelar-dojo-1", "neutron-1", "cosmoshub-4"],
  "sourceAsset": {
    "denom": "uusdc",
    "chainId": "axelar-dojo-1"
  },
  "destAsset": {
    "denom": "uatom",
    "chainId": "cosmoshub-4"
  },
  "amountIn": "1000000",
  "userSwap": {
    "swapVenue": {
      "name": "neutron-astroport",
      "chainId": "neutron-1"
    },
    "swapOperations": [
      {
        "pool": "neutron17wg25zvvud2d27pnxjv76f5xk5tm5jfda4c7003valghrlju5u6q5dt83n",
        "denomIn": "ibc/F082B65C88E4B6D5EF1DB243CDA1D331D002759E938A0F5CD3FFDC5D53B3E349",
        "denomOut": "ibc/C4CFF46FD6DE35CA4CF4CE031E643C8FDC9BA4B99AE598E9B0ED98FE3A2319F9"
      }
    ]
  },
  "userSwapAmountOut": "39330",
  "feeSwap": {
    "swapVenue": {
      "name": "neutron-astroport",
      "chainId": "neutron-1"
    },
    "swapOperations": [
      {
        "pool": "neutron1l3gtxnwjuy65rzk63k352d52ad0f2sh89kgrqwczgt56jc8nmc3qh5kag3",
        "denomIn": "ibc/F082B65C88E4B6D5EF1DB243CDA1D331D002759E938A0F5CD3FFDC5D53B3E349",
        "denomOut": "untrn"
      }
    ],
    "swapAmountOut": "100000"
  },
  "swapChainId": "neutron-1",
  "totalAffiliateFee": "0"
}
```

# PFM이란

As we can see from the previous step, the Cosmos Hub is an intermediate chain where pfmEnabled = true. PFM (packet-forward middleware) is a feature included in some chains that detects incoming IBC packets that contain forwarding data in the IBC memo field and will automatically dispatch an IBC packet to the next destination.

---

이전 단계에서 확인할 수 있듯이, Cosmos Hub은 pfmEnabled = true인 중간 체인입니다. PFM(Packet-Forward Middleware)은 일부 체인에 포함된 기능으로, IBC 메모 필드에 전달 데이터가 포함된 수신 IBC 패킷을 감지하고 자동으로 다음 목적지로의 IBC 패킷을 전달합니다.

# Construct Message

### Request

```json
- post
{
  "source_asset_denom": "uusdc",
  "source_asset_chain_id": "axelar-dojo-1",
  "dest_asset_denom": "uatom",
  "dest_asset_chain_id": "cosmoshub-4",
  "amount_in": "1000000",
  "chain_ids_to_addresses": {
    "osmosis-1": "osmo1x8ad0zyw52mvndh7hlnafrg0gt284ga7syxplu",
    "axelar-dojo-1": "axelar1x8ad0zyw52mvndh7hlnafrg0gt284ga7u3rez0",
    "cosmoshub-4": "cosmos1x8ad0zyw52mvndh7hlnafrg0gt284ga7cl43fw"
  },
  // quote한 값 그대로 넣으면 된다
  "operations": [
    {
      "transfer": {
        "port": "transfer",
        "channel": "channel-3",
        "chain_id": "axelar-dojo-1",
        "pfm_enabled": false,
        "dest_denom": "ibc/D189335C6E4A68B513C10AB227BF1C1D38C746766278BA3EEB4FB14124F1D858"
      }
    },
    {
      "swap": {
        "swap_in": {
          "swap_venue": {
            "name": "osmosis-sq",
            "chain_id": "osmosis-1"
          },
          "swap_operations": [
            {
              "pool": "678",
              "denom_in": "ibc/D189335C6E4A68B513C10AB227BF1C1D38C746766278BA3EEB4FB14124F1D858",
              "denom_out": "uosmo"
            },
            {
              "pool": "1",
              "denom_in": "uosmo",
              "denom_out": "ibc/27394FB092D2ECCD56123C74F36E4C1F926001CEADA9CA97EA622B25F41E5EB2"
            }
          ],
          "swap_amount_in": "1000000"
        },
        // Estimated total affiliate fee generated by the swap
        // 오스모 주소에 아톰을 받게 되는 형식으로 보임
        "estimated_affiliate_fee": "1069ibc/27394FB092D2ECCD56123C74F36E4C1F926001CEADA9CA97EA622B25F41E5EB2"
      }
    },
    {
      "transfer": {
        "port": "transfer",
        "channel": "channel-0",
        "chain_id": "osmosis-1",
        "pfm_enabled": true,
        "dest_denom": "uatom"
      }
    }
  ],
  "estimated_amount_out": "107033",
  "slippage_tolerance_percent": "1",
  "affiliates": [{
  // 100 basis_points_fee == 1%를 의미
  // 총 스왑되어 나올 값 == 유저가 받을 min amount + 총 스왑되어 나올 값 * (bps 포인트 * 0.01)
  // 유저가 받을 min amount = 총 스왑되어 나온 amount - 총 스왑되어 나올 값 * (bps 포인트 * 0.01)
"basis_points_fee": "100",

// 수수료 받아갈 주소
// 스왑이 이뤄지는 체인의 주소를 넣어야 하는 것으로 간주됨.(여기서는 오스모로 스왑해서 오스모 주소)
"address": "osmo1aygdt8742gamxv8ca99wzh56ry4xw5s3dtgtpf"
}]
}
```

### Response

```json

```

- 예시로 tx날려보기

```typescript
function convertSnakeCaseToCamelCase(obj) {
  if (typeof obj !== "object" || obj === null) {
    return obj;
  }

  if (Array.isArray(obj)) {
    return obj.map((item) => convertSnakeCaseToCamelCase(item));
  }

  const camelCaseObj = {};

  for (const key in obj) {
    if (obj.hasOwnProperty(key)) {
      const camelCaseKey = key.replace(/_([a-z])/g, (match, p1) =>
        p1.toUpperCase()
      );
      camelCaseObj[camelCaseKey] = convertSnakeCaseToCamelCase(obj[key]);
    }
  }

  return camelCaseObj;
}

const msg = JSON.parse(response.requested[0].msg);

try {
  const tx = await client.signAndBroadcast(
    msg.sender,
    [
      {
        typeUrl: messages.requested[0].msgTypeUrl,
        value: {
          ...convertSnakeCaseToCamelCase(msg),
          timeoutHeight: {
            // SET TIMEOUT
            revisionHeight: Long.fromNumber(currentHeight).add(100),
            revisionNumber: Long.fromNumber(currentHeight).add(100),
          },
        },
      },
    ],
    "auto"
  );

  console.log(tx.transactionHash);
} catch (e) {
  console.log(e);
}
```

https://skip-protocol.notion.site/Skip-API-9c502e3297334bd9809e3db3e6d63420

## 디앱 요청 메시지

테스트 사이트 : https://ibc.fun/

```json
{
  "account_number": "1456440",
  "auth_info_bytes": {
    "signer_infos": [
      {
        "public_key": {
          "type_url": "/cosmos.crypto.secp256k1.PubKey",
          "value": "CiECoqz7XBbK22JBjnUSeHnKSU6RmzmcWom5Psoizic2jhY="
        },
        "mode_info": {
          "single": {
            "mode": "SIGN_MODE_DIRECT"
          }
        },
        "sequence": "22"
      }
    ],
    "fee": {
      "amount": [
        {
          "denom": "uatom",
          "amount": "2920"
        }
      ],
      "gas_limit": "116782"
    }
  },
  "body_bytes": {
    "messages": [
      {
        "type_url": "/ibc.applications.transfer.v1.MsgTransfer",
        "value": "0a087472616e73666572120b6368616e6e656c2d3134311a100a057561746f6d120731303030303030222d636f736d6f733161796764743837343267616d78763863613939777a683536727934787735733339736d6d686d2a3f6f736d6f31717076753830796664306a6e6e683379746e3839363433383274797072717130656a6d7161617361336a323333737538617061736671746c657232003880fabbbdef96ccb9174282047b227761736d223a7b22636f6e7472616374223a226f736d6f31717076753830796664306a6e6e683379746e3839363433383274797072717130656a6d7161617361336a323333737538617061736671746c6572222c226d7367223a7b22737761705f776974685f616374696f6e223a7b22737761705f6d7367223a7b22746f6b656e5f6f75745f6d696e5f616d6f756e74223a223234373239393434222c2270617468223a5b7b22706f6f6c5f6964223a2231222c22746f6b656e5f6f75745f64656e6f6d223a22756f736d6f227d2c7b22706f6f6c5f6964223a22383132222c22746f6b656e5f6f75745f64656e6f6d223a226962632f39303341363141343938373536454135363042383541383531333244334145453231423544454444343132313337323544323241424632373645413639343545227d5d7d2c2261667465725f737761705f616374696f6e223a7b226962635f7472616e73666572223a7b227265636569766572223a226178656c61723161796764743837343267616d78763863613939777a68353672793478773573337037646e7536222c226368616e6e656c223a226368616e6e656c2d323038227d7d2c226c6f63616c5f66616c6c6261636b5f61646472657373223a226f736d6f3161796764743837343267616d78763863613939777a6835367279347877357333647467747066227d7d7d7d"
      }
    ],
    "extension_options": [],
    "non_critical_extension_options": []
  },
  "chain_id": "cosmoshub-4"
}
```

ibc 예시

```json
{
  "account_number": "1456440",
  "chain_id": "cosmoshub-4",
  "fee": {
    "amount": [
      {
        "amount": "291",
        "denom": "uatom"
      }
    ],
    "gas": "116379"
  },
  "memo": "",
  "msgs": [
    {
      "type": "cosmos-sdk/MsgTransfer",
      "value": {
        "receiver": "osmo1aygdt8742gamxv8ca99wzh56ry4xw5s3dtgtpf",
        "sender": "cosmos1aygdt8742gamxv8ca99wzh56ry4xw5s39smmhm",
        "source_channel": "channel-141",
        "source_port": "transfer",
        "timeout_height": {
          "revision_height": "10615081",
          "revision_number": "1"
        },
        "token": {
          "amount": "1000000",
          "denom": "uatom"
        }
      }
    }
  ],
  "sequence": "22"
}
```

케플러로 들어오는 메시지 예시

```json
{
  "accountNumber": "1456440",
  "authInfo": {
    "signerInfos": [
      {
        "publicKey": {
          "typeUrl": "/cosmos.crypto.secp256k1.PubKey",
          "value": "CiECoqz7XBbK22JBjnUSeHnKSU6RmzmcWom5Psoizic2jhY="
        },
        "modeInfo": {
          "single": {
            "mode": "SIGN_MODE_DIRECT"
          }
        },
        "sequence": "22"
      }
    ],
    "fee": {
      "amount": [
        {
          "denom": "uatom",
          "amount": "2885"
        }
      ],
      "gasLimit": "115365",
      "payer": "",
      "granter": ""
    }
  },
  "txBody": {
    "messages": [
      {
        "sourcePort": "transfer",
        "sourceChannel": "channel-141",
        "token": {
          "denom": "uatom",
          "amount": "1000000"
        },
        "sender": "cosmos1aygdt8742gamxv8ca99wzh56ry4xw5s39smmhm",
        "receiver": "osmo1qpvu80yfd0jnnh3ytn8964382typrqq0ejmqaasa3j233su8apasfqtler",
        "timeoutHeight": {
          "revisionNumber": "0",
          "revisionHeight": "0"
        },
        "timeoutTimestamp": "1689831678495576320",
        "memo": "{\"wasm\":{\"contract\":\"osmo1qpvu80yfd0jnnh3ytn8964382typrqq0ejmqaasa3j233su8apasfqtler\",\"msg\":{\"swap_with_action\":{\"swap_msg\":{\"token_out_min_amount\":\"17101698\",\"path\":[{\"pool_id\":\"1\",\"token_out_denom\":\"uosmo\"}]},\"after_swap_action\":{\"ibc_transfer\":{\"receiver\":\"cosmos1aygdt8742gamxv8ca99wzh56ry4xw5s39smmhm\",\"channel\":\"channel-0\"}},\"local_fallback_address\":\"osmo1aygdt8742gamxv8ca99wzh56ry4xw5s3dtgtpf\"}}}}"
      }
    ],
    "memo": "",
    "timeoutHeight": "0",
    "extensionOptions": [],
    "nonCriticalExtensionOptions": []
  },

  "chainId": "cosmoshub-4"
}
```

코스모스테이션으로 들어오는 메시지 예시

```json
{
  "account_number": "1456440",
  "auth_info_bytes": {
    "signer_infos": [
      {
        "public_key": {
          "type_url": "/cosmos.crypto.secp256k1.PubKey",
          "value": "CiECoqz7XBbK22JBjnUSeHnKSU6RmzmcWom5Psoizic2jhY="
        },
        "mode_info": {
          "single": {
            "mode": "SIGN_MODE_DIRECT"
          }
        },
        "sequence": "22"
      }
    ],
    "fee": {
      "amount": [
        {
          "denom": "uatom",
          "amount": "2885"
        }
      ],
      "gas_limit": "115365"
    }
  },
  "body_bytes": {
    "messages": [
      {
        "type_url": "/ibc.applications.transfer.v1.MsgTransfer",
        "value": "0a087472616e73666572120b6368616e6e656c2d3134311a100a057561746f6d120731303030303030222d636f736d6f733161796764743837343267616d78763863613939777a683536727934787735733339736d6d686d2a3f6f736d6f31717076753830796664306a6e6e683379746e3839363433383274797072717130656a6d7161617361336a323333737538617061736671746c657232003880aefdffc4a1dfb9174295037b227761736d223a7b22636f6e7472616374223a226f736d6f31717076753830796664306a6e6e683379746e3839363433383274797072717130656a6d7161617361336a323333737538617061736671746c6572222c226d7367223a7b22737761705f776974685f616374696f6e223a7b22737761705f6d7367223a7b22746f6b656e5f6f75745f6d696e5f616d6f756e74223a223137313031363938222c2270617468223a5b7b22706f6f6c5f6964223a2231222c22746f6b656e5f6f75745f64656e6f6d223a22756f736d6f227d5d7d2c2261667465725f737761705f616374696f6e223a7b226962635f7472616e73666572223a7b227265636569766572223a22636f736d6f733161796764743837343267616d78763863613939777a683536727934787735733339736d6d686d222c226368616e6e656c223a226368616e6e656c2d30227d7d2c226c6f63616c5f66616c6c6261636b5f61646472657373223a226f736d6f3161796764743837343267616d78763863613939777a6835367279347877357333647467747066227d7d7d7d"
      }
    ],
    "extension_options": [],
    "non_critical_extension_options": []
  },
  "chain_id": "cosmoshub-4"
}
```

```json
{
  "account_number": "1456440",
  "chain_id": "cosmoshub-4",
  "fee": {
    "amount": [
      {
        "amount": "625",
        "denom": "uatom"
      }
    ],
    "gas": "250000"
  },
  "memo": "",
  "msgs": [
    {
      "type": "cosmos-sdk/MsgTransfer",
      "value": {
        "memo": "{\"wasm\":{\"contract\":\"osmo1qpvu80yfd0jnnh3ytn8964382typrqq0ejmqaasa3j233su8apasfqtler\",\"msg\":{\"swap_with_action\":{\"swap_msg\":{\"token_out_min_amount\":\"17853296\",\"path\":[{\"pool_id\":\"1\",\"token_out_denom\":\"uosmo\"}]},\"after_swap_action\":{\"ibc_transfer\":{\"receiver\":\"cosmos1aygdt8742gamxv8ca99wzh56ry4xw5s39smmhm\",\"channel\":\"channel-0\"}},\"local_fallback_address\":\"osmo1aygdt8742gamxv8ca99wzh56ry4xw5s3dtgtpf\"}}}}",
        "receiver": "osmo1qpvu80yfd0jnnh3ytn8964382typrqq0ejmqaasa3j233su8apasfqtler",
        "sender": "cosmos1aygdt8742gamxv8ca99wzh56ry4xw5s39smmhm",
        "source_channel": "channel-141",
        "source_port": "transfer",
        "timeout_height": {
          "revision_height": "0",
          "revision_number": "0"
        },
        "timeout_timestamp": 1689840072807617800,
        "token": {
          "amount": "1000000",
          "denom": "uatom"
        }
      }
    }
  ],
  "sequence": "22"
}
```

```json
{
  "account_number": "1456440",
  "chain_id": "cosmoshub-4",
  "fee": {
    "amount": [
      {
        "amount": "291",
        "denom": "uatom"
      }
    ],
    "gas": "116340"
  },
  "memo": "",
  "msgs": [
    {
      "type": "cosmos-sdk/MsgTransfer",
      "value": {
        "receiver": "osmo1aygdt8742gamxv8ca99wzh56ry4xw5s3dtgtpf",
        "sender": "cosmos1aygdt8742gamxv8ca99wzh56ry4xw5s39smmhm",
        "source_channel": "channel-141",
        "source_port": "transfer",
        "timeout_height": {
          "revision_height": "10616676",
          "revision_number": "1"
        },
        "token": {
          "amount": "1000000",
          "denom": "uatom"
        }
      }
    }
  ],
  "sequence": "22"
}
```
